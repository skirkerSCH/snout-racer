<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Corgi POV: Snout Speed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        /* CRITICAL FIX: Ensure html/body take full height */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Fredoka One', cursive;
            touch-action: manipulation;
            user-select: none;
            background-color: #87CEEB; /* Sky Blue fallback */
            position: relative;
        }

        /* The World Container */
        #scene {
            perspective: 600px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            z-index: 0;
        }

        /* Sky */
        .sky {
            position: absolute;
            top: 0;
            width: 100%;
            height: 55%; /* Slight overlap to prevent gaps */
            background: linear-gradient(to bottom, #60a5fa, #bae6fd);
            z-index: 0;
        }

        /* Ground (The Track) */
        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50%;
            background-color: #4ade80;
            /* Checkered Grass Pattern */
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(0deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 100px 100px; 
            transform-origin: 50% 0%; 
            transform: rotateX(30deg) scale(2);
            z-index: 1;
            will-change: background-position;
        }

        /* The Snout Overlay */
        #snout-container {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 200px;
            z-index: 50;
            pointer-events: none;
            will-change: transform;
        }

        /* Snout Animation */
        @keyframes pant {
            0%, 100% { transform: translateX(-50%) translateY(0px) scale(1); }
            50% { transform: translateX(-50%) translateY(5px) scale(1.02); }
        }
        @keyframes run-bob {
            0%, 100% { transform: translateX(-50%) translateY(0px) rotate(0deg); }
            25% { transform: translateX(-52%) translateY(15px) rotate(-2deg); }
            75% { transform: translateX(-48%) translateY(15px) rotate(2deg); }
        }
        
        .snout-idle { animation: pant 2s infinite ease-in-out; }
        .snout-running { animation: run-bob 0.3s infinite linear; }

        /* Opponent Sprites */
        .sprite {
            position: absolute;
            bottom: 50%; 
            left: 50%;
            transform-origin: bottom center;
            will-change: transform, opacity;
            z-index: 10;
        }

        /* UI Elements */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* HUD */
        .hud-panel {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .speed-lines {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 50%, rgba(255,255,255,0.8) 100%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 40;
        }
    </style>
</head>
<body>

    <div id="scene">
        <div class="sky">
            <div class="absolute top-10 left-10 text-white opacity-60 text-6xl">‚òÅÔ∏è</div>
            <div class="absolute top-20 right-20 text-white opacity-60 text-4xl">‚òÅÔ∏è</div>
            <div class="absolute top-5 left-1/2 text-white opacity-40 text-5xl">‚òÅÔ∏è</div>
        </div>
        
        <div class="ground" id="ground"></div>

        <div id="world-objects">
            <!-- Sprites injected here -->
        </div>

        <!-- Finish Line -->
        <div id="finish-line-obj" class="sprite" style="opacity: 0;">
            <svg width="400" height="300" viewBox="0 0 400 300" style="overflow: visible;">
                <defs>
                    <pattern id="checkerPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                        <rect width="20" height="20" fill="black"/>
                        <rect x="20" y="0" width="20" height="20" fill="white"/>
                        <rect x="0" y="20" width="20" height="20" fill="white"/>
                        <rect x="20" y="20" width="20" height="20" fill="black"/>
                    </pattern>
                </defs>
                
                <!-- Left Post -->
                <rect x="20" y="50" width="20" height="250" fill="#cbd5e1" stroke="#334155" stroke-width="2"/>
                <!-- Right Post -->
                <rect x="360" y="50" width="20" height="250" fill="#cbd5e1" stroke="#334155" stroke-width="2"/>
                
                <!-- Top Banner -->
                <rect x="10" y="50" width="380" height="80" fill="#ef4444" stroke="#7f1d1d" stroke-width="4"/>
                
                <!-- Checkered Strip -->
                <rect x="20" y="60" width="360" height="20" fill="url(#checkerPattern)" stroke="#333" stroke-width="1"/>
                
                <!-- Text -->
                <text x="200" y="115" text-anchor="middle" font-weight="900" font-size="40" fill="white" stroke="black" stroke-width="2" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.5);">FINISH</text>
            </svg>
        </div>

        <!-- Speed Lines -->
        <div id="speed-lines" class="speed-lines"></div>

        <!-- PLAYER SNOUT -->
        <div id="snout-container" class="snout-idle">
            <svg viewBox="0 0 200 150" width="100%" height="100%">
                <path d="M-20 150 L20 80 L60 150 Z" fill="#d97706"/>
                <path d="M140 150 L180 80 L220 150 Z" fill="#d97706"/>
                <path d="M50 150 Q100 20 150 150" fill="#f97316" stroke="#c2410c" stroke-width="2"/>
                <path d="M85 150 Q100 60 115 150" fill="#fff7ed"/>
                <ellipse cx="100" cy="85" rx="15" ry="10" fill="#1e293b"/>
                <ellipse cx="103" cy="83" rx="4" ry="2" fill="#475569"/>
                <line x1="60" y1="90" x2="40" y2="85" stroke="#1e293b" stroke-width="1" opacity="0.5"/>
                <line x1="60" y1="100" x2="35" y2="105" stroke="#1e293b" stroke-width="1" opacity="0.5"/>
                <line x1="140" y1="90" x2="160" y2="85" stroke="#1e293b" stroke-width="1" opacity="0.5"/>
                <line x1="140" y1="100" x2="165" y2="105" stroke="#1e293b" stroke-width="1" opacity="0.5"/>
            </svg>
        </div>
    </div>

    <!-- UI Layer -->
    <div class="ui-overlay">
        <div class="hud-panel">
            <div class="bg-white/80 backdrop-blur rounded-xl p-2 shadow border-b-4 border-orange-500">
                <div class="text-xs text-slate-500 uppercase font-bold">Distance</div>
                <div class="text-2xl text-orange-600 font-black"><span id="dist-display">0</span>m</div>
            </div>
            
            <div class="bg-white/80 backdrop-blur rounded-xl p-2 shadow border-b-4 border-blue-500">
                <div class="text-xs text-slate-500 uppercase font-bold">Pos</div>
                <div class="text-2xl text-blue-600 font-black"><span id="rank-display">4</span>/4</div>
            </div>
        </div>

        <!-- Center Start/Controls -->
        <div id="start-screen" class="absolute inset-0 flex items-center justify-center z-50 pointer-events-auto bg-black/30 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-3xl shadow-2xl text-center max-w-sm mx-4 animate-bounce-in">
                <h1 class="text-4xl text-orange-600 mb-2 drop-shadow-sm">üêæ Snout Racer</h1>
                <!-- We will update this subtitle to show current speed % -->
                <p id="level-info" class="text-slate-600 mb-6 text-lg font-bold">Opponent Speed: 100%</p>
                <button id="start-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-2xl py-4 rounded-xl shadow-[0_4px_0_rgb(194,65,12)] active:shadow-none active:translate-y-1 transition-all uppercase font-bold">
                    Start Running!
                </button>
            </div>
        </div>
    </div>
    
    <!-- Victory/Loss Modal -->
    <div id="result-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-md">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 transform scale-100">
            <div id="result-emoji" class="text-7xl mb-4">üèÜ</div>
            <h2 id="result-title" class="text-4xl text-orange-600 mb-2">1st Place!</h2>
            <p id="result-msg" class="text-slate-600 mb-6">The fastest snout in the west.</p>
            <button id="restart-btn" class="bg-sky-500 hover:bg-sky-600 text-white py-3 px-8 rounded-xl text-xl shadow-[0_4px_0_rgb(3,105,161)] active:translate-y-1 transition-all">
                Race Again
            </button>
        </div>
    </div>

    <script>
        // --- Game Config ---
        const RACE_DISTANCE = 1000; 
        const FOV_SCALE = 150; 
        
        // --- State ---
        let level = 1;
        let difficultyMultiplier = 1.0;
        let isRacing = false;
        let playerZ = 0;
        let playerSpeed = 0;
        let lastTimestamp = null; 
        let gameFinished = false;
        let animationFrameId = null; 
        let finalRank = null; // NEW: To store rank when crossing line

        // --- Rivals ---
        const RIVALS = [
            { id: 1, name: 'Waffles', color: '#eab308', z: 0, speedBase: 0, xOffset: -180, finished: false },
            { id: 2, name: 'Biscuit', color: '#d97706', z: 0, speedBase: 0, xOffset: 0, finished: false },
            { id: 3, name: 'Shorty', color: '#fb7185', z: 0, speedBase: 0, xOffset: 180, finished: false }
        ];

        // --- DOM Elements ---
        const ground = document.getElementById('ground');
        const worldObjContainer = document.getElementById('world-objects');
        const snout = document.getElementById('snout-container');
        const speedLines = document.getElementById('speed-lines');
        const distDisplay = document.getElementById('dist-display');
        const rankDisplay = document.getElementById('rank-display');
        const startScreen = document.getElementById('start-screen');
        const resultModal = document.getElementById('result-modal');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const levelInfo = document.getElementById('level-info');

        function getCorgiButtSVG(color) {
            return `
            <svg viewBox="0 0 100 100" width="100%" height="100%" style="overflow:visible">
                <path d="M30 70 L30 90" stroke="#334155" stroke-width="6" stroke-linecap="round"/>
                <path d="M70 70 L70 90" stroke="#334155" stroke-width="6" stroke-linecap="round"/>
                <rect x="20" y="30" width="60" height="50" rx="25" fill="${color}" stroke="#334155" stroke-width="2"/>
                <path d="M35 40 Q50 20 65 40 L65 70 Q50 90 35 70 Z" fill="#fff7ed" opacity="0.9"/>
                <circle cx="50" cy="50" r="6" fill="${color}" stroke="#334155" stroke-width="2"/>
                <path d="M25 35 L20 15 L35 30" fill="${color}" stroke="#334155" stroke-width="2"/>
                <path d="M75 35 L80 15 L65 30" fill="${color}" stroke="#334155" stroke-width="2"/>
            </svg>`;
        }

        function init() {
            // NEW: Define speed tiers (Slow, Medium, Fast) so the race is always balanced,
            // but the specific dog taking each role is randomized.
            const speedTiers = [0.10, 0.11, 0.125];
            
            // Shuffle the tiers randomly
            for (let i = speedTiers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [speedTiers[i], speedTiers[j]] = [speedTiers[j], speedTiers[i]];
            }

            RIVALS.forEach((rival, index) => {
                // Reset stats
                rival.z = -20;
                rival.finished = false;
                
                // Assign one of the shuffled speeds to this corgi
                // Now any dog can be the fast one!
                let basePersonalitySpeed = speedTiers[index]; 

                const dailyVariance = Math.random() * 0.0005;

                // The difficulty multiplier now acts on a stable base
                rival.speedBase = (basePersonalitySpeed + dailyVariance) * difficultyMultiplier;

                const el = document.createElement('div');
                el.className = 'sprite';
                el.style.width = '100px';
                el.style.height = '100px';
                const tag = document.createElement('div');
                tag.className = "absolute -top-4 left-1/2 -translate-x-1/2 bg-black/50 text-white text-xs px-2 rounded-full whitespace-nowrap";
                tag.innerText = rival.name;
                const img = document.createElement('div');
                img.innerHTML = getCorgiButtSVG(rival.color);
                el.appendChild(tag);
                el.appendChild(img);
                rival.el = el;
                worldObjContainer.appendChild(el);
            });
        }

        function resetGame() {
            resultModal.classList.add('hidden');
            startScreen.classList.remove('hidden');
            
            // Reset State
            isRacing = false;
            gameFinished = false;
            finalRank = null; // Reset rank
            playerZ = 0;
            playerSpeed = 0;
            lastTimestamp = null;
            
            // Reset UI
            snout.className = 'snout-idle';
            speedLines.style.opacity = 0;
            distDisplay.innerText = '0';
            rankDisplay.innerText = '4/4'; 
            ground.style.backgroundPositionY = '0px';

            // Reset Rivals
            worldObjContainer.innerHTML = ''; 
            init(); 
            
            // Update Start Screen UI
            document.querySelector('#start-screen h1').innerText = `üêæ Snout Racer (Lvl ${level})`;
            levelInfo.innerText = `Opponent Speed: ${Math.round(difficultyMultiplier * 100)}%`;
        }

        function update(timestamp) {
            // First frame logic: synchronize timestamp
            if (lastTimestamp === null) {
                lastTimestamp = timestamp;
                animationFrameId = requestAnimationFrame(update);
                return;
            }
            
            const dt = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            if (isRacing && !gameFinished) {
                // 1. Move Player
                playerSpeed *= 0.98; 
                playerZ += playerSpeed * dt;

                // 2. Move Rivals
                RIVALS.forEach(rival => {
                    // FIX: CRITICAL CHANGE
                    // Reduced randomness from 0.05 down to 0.002.
                    // Now the random jitter is minimal, so the 1% level boost is the dominant factor.
                    const randomJitter = (Math.random() * 0.002 * difficultyMultiplier);
                    
                    const move = (rival.speedBase + randomJitter) * dt * 1.5; 
                    rival.z += move;
                });

                // 3. Check Rank
                // If we haven't crossed the line yet, update rank normally
                if (finalRank === null) {
                    const myRank = RIVALS.filter(r => r.z > (playerZ - 80)).length + 1;
                    rankDisplay.innerText = myRank;
                    distDisplay.innerText = Math.floor(playerZ / 10);
                }

                // 4. Visuals
                ground.style.backgroundPositionY = `${playerZ * 2}px`;

                if (playerSpeed > 0.1) {
                    snout.className = 'snout-running';
                    speedLines.style.opacity = Math.min(playerSpeed, 0.8);
                } else {
                    snout.className = 'snout-idle';
                    speedLines.style.opacity = 0;
                }

                // 5. Cross Line Check
                if (playerZ >= RACE_DISTANCE) {
                    if (finalRank === null) {
                        // Capture rank the moment we cross 1000m
                        finalRank = RIVALS.filter(r => r.z > (playerZ - 80)).length + 1;
                        rankDisplay.innerText = finalRank; // Lock display
                        distDisplay.innerText = "FINISH!";
                        distDisplay.parentElement.classList.replace('border-orange-500', 'border-green-500');
                        distDisplay.classList.replace('text-orange-600', 'text-green-600');
                    }
                }

                // 6. End Game Logic (Run PAST the line)
                // CHANGED: Reduced from +500 to +200 so the game ends snappier after crossing
                if (playerZ >= RACE_DISTANCE + 200) {
                     finishGame(finalRank);
                }
            }

            render3D();
            animationFrameId = requestAnimationFrame(update);
        }

        function render3D() {
            const DEPTH_OFFSET = 100; 

            RIVALS.forEach(rival => {
                const dist = rival.z - playerZ;
                
                if (dist < -80) { 
                    rival.el.style.display = 'none';
                    return;
                }

                const zDepth = dist + DEPTH_OFFSET; 
                
                if (zDepth > 10) {
                    const scale = FOV_SCALE / zDepth;
                    const xPos = rival.xOffset * scale;
                    const yPos = 20 * scale; 

                    rival.el.style.display = 'block';
                    rival.el.style.transform = `translate(-50%, 0) translate(${xPos}px, ${yPos}px) scale(${scale})`;
                    rival.el.style.zIndex = Math.floor(2000 - dist);
                    
                    const bounce = Math.sin(Date.now() * 0.02) * 10 * scale;
                    rival.el.children[1].style.transform = `translateY(${-Math.abs(bounce)}px)`;
                } else {
                    rival.el.style.display = 'none';
                }
            });

            const finishDist = RACE_DISTANCE - playerZ;
            const finishDepth = finishDist + DEPTH_OFFSET;
            const finishEl = document.getElementById('finish-line-obj');
            
            if (finishDepth > 10) {
                const scale = FOV_SCALE / finishDepth;
                finishEl.style.opacity = 1;
                finishEl.style.transform = `translate(-50%, 0) scale(${scale})`;
                finishEl.style.bottom = '50%';
            } else if (finishDepth < -200) {
                finishEl.style.opacity = 0;
            }
        }

        function tap(e) {
            if (!isRacing) return;
            
            if (e.type === 'touchstart') {
                // e.preventDefault(); 
            }
            
            playerSpeed += 0.15;
            if (playerSpeed > 2.5) playerSpeed = 2.5; 
            
            // Instant feedback
            snout.style.transform = `translateX(-50%) translateY(10px) scale(0.95)`;
            setTimeout(() => {
                snout.style.transform = ``; 
            }, 50);
        }

        function startGame(e) {
            e.stopPropagation(); 
            
            startScreen.classList.add('hidden');
            isRacing = true;
            gameFinished = false;
            lastTimestamp = null; 
            
            // FIX: Prevent double-loops
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            animationFrameId = requestAnimationFrame(update);
        }

        function finishGame(rank) {
            gameFinished = true;
            isRacing = false;
            snout.className = 'snout-idle';
            speedLines.style.opacity = 0;

            setTimeout(() => {
                resultModal.classList.remove('hidden');
                const title = document.getElementById('result-title');
                const msg = document.getElementById('result-msg');
                const emoji = document.getElementById('result-emoji');

                if (rank === 1) {
                    level++;
                    // CHANGED: Increased difficulty jump from 6% to 10% as requested
                    difficultyMultiplier += 0.10; 
                    
                    title.innerText = "1st Place!";
                    title.className = "text-4xl text-orange-600 font-black mb-2";
                    msg.innerText = "You are the Alpha Corgi!";
                    emoji.innerText = "üèÜüëë";
                    restartBtn.innerText = `Start Level ${level}`;
                    restartBtn.className = "bg-green-500 hover:bg-green-600 text-white py-3 px-8 rounded-xl text-xl shadow-[0_4px_0_rgb(21,128,61)] active:translate-y-1 transition-all";
                } else {
                    title.innerText = `${rank}th Place`;
                    title.className = "text-4xl text-slate-600 font-black mb-2";
                    msg.innerText = "Good hustle, little loaf.";
                    emoji.innerText = "ü¶¥";
                    restartBtn.innerText = "Try Again";
                    restartBtn.className = "bg-sky-500 hover:bg-sky-600 text-white py-3 px-8 rounded-xl text-xl shadow-[0_4px_0_rgb(3,105,161)] active:translate-y-1 transition-all";
                }
            }, 1000);
        }

        // --- Setup Events ---
        startBtn.addEventListener('click', startGame);
        startBtn.addEventListener('touchstart', startGame, {passive: false});

        restartBtn.addEventListener('click', resetGame); 

        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('button')) return;
            tap(e);
        });
        
        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('button')) return;
            tap(e);
        }, {passive: false});
        
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                tap(e);
            }
        });

        init();

    </script>
</body>
</html>
